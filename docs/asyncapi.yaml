asyncapi: 3.0.0
info:
  title: FFC Payment Statement Publisher
  version: 1.0.2
  description: Publish PDF payment statements for Future Farming
channels:
  ffc-doc-statement-publish/ffc-doc-statement-publisher:
    address: ffc-doc-statement-publish/ffc-doc-statement-publisher
    messages:
      subscribeToPublisher.message.0:
        $ref: '#/components/messages/PublishRequest'
      subscribeToPublisher.message.1:
        $ref: '#/components/messages/DelinkedPublishRequest'
  ffc-doc-statement-crm:
    address: ffc-doc-statement-crm
    messages:
      publishToCrm.message:
        $ref: '#/components/messages/CrmInvalidEmailResponse'
operations:
  subscribeToPublisher:
    action: send
    channel:
      $ref: '#/channels/ffc-doc-statement-publish~1ffc-doc-statement-publisher'
    summary: Subscribe to publisher
    messages:
      - $ref: >-
          #/channels/ffc-doc-statement-publish~1ffc-doc-statement-publisher/messages/subscribeToPublisher.message.0
      - $ref: >-
          #/channels/ffc-doc-statement-publish~1ffc-doc-statement-publisher/messages/subscribeToPublisher.message.1
  publishToCrm:
    action: receive
    channel:
      $ref: '#/channels/ffc-doc-statement-crm'
    summary: Publish to CRM
    messages:
      - $ref: '#/channels/ffc-doc-statement-crm/messages/publishToCrm.message'
components:
  messages:
    DelinkedPublishRequest:
      title: Delinked Publish request
      name: Delinked payment statement publish request
      contentType: application/json
      payload:
        $ref: '#/components/schemas/DelinkedPublishRequest'
    CrmInvalidEmailResponse:
      title: Invalid Email Response
      name: Payment statement invalid email response
      contentType: application/json
      payload:
        $ref: '#/components/schemas/CrmInvalidEmailResponse'
    PublishRequest:
      title: Publish request
      name: Payment statement publish request
      contentType: application/json
      payload:
        $ref: '#/components/schemas/PublishRequest'
  schemas:
    DelinkedPublishRequest:
      type: object
      properties:
        businessName:
          $ref: '#/components/schemas/BusinessName'
        address:
          $ref: '#/components/schemas/Address'
        documentReference:
          $ref: '#/components/schemas/DocumentReference'
        email:
          $ref: '#/components/schemas/Email'
        filename:
          $ref: '#/components/schemas/FilenameDelinked'
        frn:
          $ref: '#/components/schemas/FRN'
        sbi:
          $ref: '#/components/schemas/SBI'
        paymentBand1:
          $ref: "#/components/schemas/PaymentBand1"
        paymentBand2:
          $ref: "#/components/schemas/PaymentBand2"
        paymentBand3:
          $ref: "#/components/schemas/PaymentBand3"
        paymentBand4:
          $ref: "#/components/schemas/PaymentBand4"
        percentageReduction1:
          $ref: "#/components/schemas/PercentageReduction1"
        percentageReduction2:
          $ref: "#/components/schemas/PercentageReduction2"
        percentageReduction3:
          $ref: "#/components/schemas/PercentageReduction3"
        percentageReduction4:
          $ref: "#/components/schemas/PercentageReduction4"
        progressiveReductions1:
          $ref: "#/components/schemas/ProgressiveReductions1"
        progressiveReductions2:
          $ref: "#/components/schemas/ProgressiveReductions2"
        progressiveReductions3:
          $ref: "#/components/schemas/ProgressiveReductions3"
        progressiveReductions4:
          $ref: "#/components/schemas/ProgressiveReductions4"
        referenceAmount:
          $ref: "#/components/schemas/ReferenceAmount"
        totalProgressiveReduction:
          $ref: "#/components/schemas/TotalProgressiveReduction"
        totalDelinkedPayment:
          $ref: "#/components/schemas/TotalDelinkedPayment"
        transactionDate:
          $ref: "#/components/schemas/TransactionDate"
        paymentAmount:
          type: string
          description: The calculated payment amount
          example: "5000.00"
          pattern: '^\d+\.\d{2}$'
        paymentPeriod:
          $ref: "#/components/schemas/PaymentPeriod"
        paymentAmountCalculated:
          $ref: "#/components/schemas/PaymentAmountCalculated"
        scheme:
          $ref: '#/components/schemas/SchemeDelinked'
        type:
          $ref: '#/components/schemas/TypeDelinked'
    CrmInvalidEmailResponse:
      type: object
      required:
        - email
        - errorMessage
        - frn
      properties:
        email:
          $ref: '#/components/schemas/Email'
        errorMessage:
          $ref: '#/components/schemas/ErrorMessage'
        frn:
          $ref: '#/components/schemas/FRN'
    PublishRequest:
      type: object
      required:
        - address
        - businessName
        - documentReference
        - filename
        - frn
        - sbi
        - scheme
      properties:
        address:
          $ref: '#/components/schemas/Address'
        businessName:
          $ref: '#/components/schemas/BusinessName'
        documentReference:
          $ref: '#/components/schemas/DocumentReference'
        email:
          $ref: '#/components/schemas/Email'
        filename:
          $ref: '#/components/schemas/Filename'
        frn:
          $ref: '#/components/schemas/FRN'
        sbi:
          $ref: '#/components/schemas/SBI'
        scheme:
          $ref: '#/components/schemas/Scheme'
        type:
          $ref: '#/components/schemas/TypeSFI23'
    Address:
      type: object
      properties:
        line1:
          type: string
          description: The first line of the address
          example: 1 The Street
        line2:
          type: string
          description: The second line of the address
          example: The Area
        line3:
          type: string
          description: The third line of the address
          example: The Town
        line4:
          type: string
          description: The fourth line of the address
          example: The Region
        line5:
          type: string
          description: The fifth line of the address
          example: The County
        postcode:
          type: string
          description: The postcode
          example: AB1 2CD
    AgreementNumber:
      type: number
      description: The agreement number
      example: 123456789
    BusinessName:
      type: string
      description: The business name
      example: FFC Ltd
    DocumentReference:
      type: number
      description: Unique identifier of the document
      minimum: 1
      example: 1
    Email:
      type: string
      description: The business email address
      example: farm@farms.com
    ErrorMessage:
      type: string
      description: The invalid email reasoning
      enum:
        - The statement cannot be emailed as no email address was provided.
        - >-
          We failed to send the statement because the email address provided was
          invalid.
      example: >-
        We failed to send the statement because the email address provided was
        invalid.
    FRN:
      type: number
      description: Firm Reference Number
      minimum: 1000000000
      maximum: 9999999999
      example: 1234567890
    FilenameDelinked:
      type: string
      description: >-
        PDF filename, formatted as product code using 3 to 6 uppercase
        characters, descriptor in PascalCase, Scheme ID using 3 to 6 uppercase
        characters, Scheme Year using 4 digits, FRN using 10 digits, date and
        time using 16 digits and then .pdf. All separated by underscore.
      example: FFC_PaymentStatement_DP_2023_1234567890_2022080515301212.pdf
      pattern: >-
        ^[A-Z]{3,6}\_[A-Z]([A-Z0-9]*[a-z][a-z0-9]*[A-Z]|[a-z0-9]*[A-Z][A-Z0-9]*[a-z])[A-Za-z0-9]*\_[A-Z]{3,6}_\d{4}_\d{10}_\d{16}\.pdf$
    Filename:
      type: string
      description: >-
        PDF filename, formatted as product code using 3 to 6 uppercase
        characters, descriptor in PascalCase, Scheme ID using 3 to 6 uppercase
        characters, Scheme Year using 4 digits, FRN using 10 digits, date and
        time using 16 digits and then .pdf. All separated by underscore.
      example: FFC_PaymentSfi23QuarterlyStatement_SFI_2023_1234567890_2022080515301212.pdf
      pattern: >-
        ^[A-Z]{3,6}\_[A-Z]([A-Z0-9]*[a-z][a-z0-9]*[A-Z]|[a-z0-9]*[A-Z][A-Z0-9]*[a-z])[A-Za-z0-9]*\_[A-Z]{3,6}_\d{4}_\d{10}_\d{16}\.pdf$
    PaymentAmountCalculated:
      type: string
      description: TotalDelinkedPayment /2 should match paymentAmount
      example: "25125.00"
      pattern: '^\d+\.\d{2}$'
    PaymentPeriod:
          type: string
          description: The period covered by the payment
          example: "1st Day of some date"
          maxLength: 200
    PaymentBand1:
      type: string
      description: first payment band bracket amount
      example: "30000"
      pattern: '^\d+(\.\d{2})?$'
    PaymentBand2:
      type: string
      description: second payment band bracket amount
      example: "50000"
      pattern: '^\d+(\.\d{2})?$'
    PaymentBand3:
      type: string
      description: third payment band bracket amount
      example: "150000"
      pattern: '^\d+(\.\d{2})?$'
    PaymentBand4:
      type: string
      description: fourth payment band bracket amount
      example: "99999999.99"
      pattern: '^\d+(\.\d{2})?$'    
    PercentageReduction1:
      type: string
      description: First percentage bracket for progressive reductions
      example: "50.00"
      pattern: '^\d{1,3}\.\d{2}$'
    PercentageReduction2:
      type: string
      description: Second percentage bracket for progressive reductions
      example: "55.00"
      pattern: '^\d{1,3}\.\d{2}$'
    PercentageReduction3:
      type: string
      description: Third percentage bracket for progressive reductions
      example: "60.00"
      pattern: '^\d{1,3}\.\d{2}$'
    PercentageReduction4:
      type: string
      description: Fourth percentage bracket for progressive reductions
      example: "70.00"
      pattern: '^\d{1,3}\.\d{2}$'    
    ProgressiveReductions1:
      type: string
      description: Value against band1 for progressive reductions
      example: "11000.00"
      pattern: '^\d+\.\d{2}$'
    ProgressiveReductions2:
      type: string
      description: Value against band2 for progressive reductions
      example: "22000.00"
      pattern: '^\d+\.\d{2}$'
    ProgressiveReductions3:
      type: string
      description: Value against band3 for progressive reductions
      example: "33000.00"
      pattern: '^\d+\.\d{2}$'
    ProgressiveReductions4:
      type: string
      description: Value against band4 for progressive reductions
      example: "44000.00"
      pattern: '^\d+\.\d{2}$'    
    ReferenceAmount:
      type: string
      description: Current reference amount of total
      example: "125000.00"
      pattern: '^\d+\.\d{2}$'    
    SBI:
      type: number
      description: Single Business Identifier
      minimum: 105000000
      maximum: 999999999
      example: 123456789
    Scheme:
      type: object
      required:
        - agreementNumber
        - frequency
        - name
        - shortName
        - year
      properties:
        agreementNumber:
          $ref: '#/components/schemas/AgreementNumber'
        frequency:
          $ref: '#/components/schemas/SchemeFrequency'
        name:
          $ref: '#/components/schemas/SchemeName'
        shortName:
          $ref: '#/components/schemas/SchemeShortName'
        year:
          $ref: '#/components/schemas/SchemeYear'
    SchemeDelinked:
      type: object
      required:
        - name
        - shortName
        - year
      properties:
        agreementNumber:
          $ref: '#/components/schemas/AgreementNumber'
        name:
          $ref: '#/components/schemas/SchemeNameDelinked'
        shortName:
          $ref: '#/components/schemas/SchemeShortNameDelinked'
        year:
          $ref: '#/components/schemas/SchemeYearDelinked'
    SchemeNameDelinked:
      type: string
      description: The name of the scheme
      example: Delinked payments
    SchemeName:
      type: string
      description: The name of the scheme
      example: Sustainable Farming Incentive
    SchemeShortNameDelinked:
      type: string
      description: The short name of the scheme
      example: DP
    SchemeShortName:
      type: string
      description: The short name of the scheme
      example: SFI
    SchemeYearDelinked:
      type: string
      description: The marketing year
      example: '2023'
    SchemeYear:
      type: string
      description: The marketing year
      example: '2022'
    SchemeFrequency:
      type: string
      description: The frequency of payments
      example: Quarterly
    TotalDelinkedPayment:
      type: string
      description: Total annual delinked payment amount
      example: "50250.00"
      pattern: '^\d+\.\d{2}$'
    TotalProgressiveReduction:
      type: string
      description: Total progressive reduction amount
      example: "74750.00"
      pattern: '^\d+\.\d{2}$'
    TransactionDate:
      type: string
      format: date-time
      description: The date the transaction was made
      example: "2022-08-22T16:45:20.891Z"
    TypeDelinked:
      type: string
      enum:
        - "uk.gov.doc.delinked-statement.publish"
      description:  DELINKED CALCULATION document type
    TypeSFI23:
      type: string
      enum:
        - "uk.gov.doc.sfi-23-quarterly-statement.publish"  
